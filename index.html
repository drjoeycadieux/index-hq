<!DOCTYPE html>
<html lang="en" class="antialiased">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Hydro-Québec Outage Maps</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: "class" };
    </script>

    <!-- Leaflet & MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
    />

    <style>
      /* Map sizing */
      .map-container {
        height: 100%;
        width: 100%;
      }

      /* Pulse marker for current outages */
      .pulse {
        position: relative;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #ff4500;
        box-shadow: 0 0 8px rgba(255, 69, 0, 0.6);
        border: 2px solid #fff;
      }
      .pulse::after {
        content: "";
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: rgba(255, 69, 0, 0.15);
        animation: pulse 1.6s infinite ease-out;
      }
      @keyframes pulse {
        0% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.9;
        }
        70% {
          transform: translate(-50%, -50%) scale(2.4);
          opacity: 0;
        }
        100% {
          opacity: 0;
        }
      }

      /* Planned outage marker */
      .planned {
        position: relative;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #ffa500;
        box-shadow: 0 0 8px rgba(255, 165, 0, 0.6);
        border: 2px solid #fff;
      }
      .planned::after {
        content: "";
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: rgba(255, 165, 0, 0.15);
        animation: planned-pulse 2s infinite ease-out;
      }
      @keyframes planned-pulse {
        0% {
          transform: translate(-50%, -50%) scale(1);
          opacity: 0.7;
        }
        70% {
          transform: translate(-50%, -50%) scale(2.2);
          opacity: 0;
        }
        100% {
          opacity: 0;
        }
      }

      /* Cluster */
      .custom-cluster {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 999px;
        padding: 6px 10px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
        border: 2px solid rgba(0, 0, 0, 0.06);
        color: #111827;
        font-weight: 700;
      }
      .dark .custom-cluster {
        background: rgba(17, 24, 39, 0.95);
        color: #fff;
        border-color: rgba(255, 255, 255, 0.06);
      }

      /* Spinner */
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.08);
        border-top-color: rgba(0, 0, 0, 0.6);
        border-radius: 9999px;
        width: 36px;
        height: 36px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Skeleton */
      .skeleton {
        background: linear-gradient(
          90deg,
          rgba(0, 0, 0, 0.06),
          rgba(0, 0, 0, 0.02),
          rgba(0, 0, 0, 0.06)
        );
        background-size: 200% 100%;
        animation: shimmer 1.6s infinite linear;
        border-radius: 6px;
      }
      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* small tweaks */
      .leaflet-container {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
      }
      @media (max-width: 768px) {
        .map-container {
          top: 0;
          left: 0;
        }
        aside {
          display: none;
        }
      }

      /* Map tabs */
      .map-tabs {
        display: flex;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
      }
      .dark .map-tabs {
        border-bottom-color: rgba(255, 255, 255, 0.1);
      }
      .map-tab {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }
      .map-tab.active {
        border-bottom-color: #3b82f6;
        color: #3b82f6;
        font-weight: 600;
      }
      .map-content {
        display: none;
      }
      .map-content.active {
        display: block;
      }

      /* Search box styles */
      .search-container {
        position: absolute;
        top: 80px;
        left: 20px;
        z-index: 1000;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 8px;
        width: 300px;
      }
      .dark .search-container {
        background: #374151;
        color: white;
      }
      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
      }
      .dark .search-input {
        background: #4b5563;
        border-color: #6b7280;
        color: white;
      }
      .search-input:focus {
        border-color: #3b82f6;
      }
      .search-results {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 8px;
        border-radius: 6px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .dark .search-results {
        background: #4b5563;
      }
      .search-result-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        font-size: 14px;
      }
      .dark .search-result-item {
        border-bottom-color: #6b7280;
      }
      .search-result-item:hover {
        background: #f3f4f6;
      }
      .dark .search-result-item:hover {
        background: #6b7280;
      }
      .search-result-item:last-child {
        border-bottom: none;
      }
      .search-no-results {
        padding: 8px 12px;
        font-size: 14px;
        color: #6b7280;
        text-align: center;
      }
      .dark .search-no-results {
        color: #9ca3af;
      }

      /* Status indicators */
      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
      }
      .status-active {
        background-color: #ff4500;
      }
      .status-planned {
        background-color: #ffa500;
      }
    </style>
  </head>

  <body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100">
    <!-- Outage Banner -->
    <!-- <div
      id="outage-banner"
      class="w-full text-center px-4 py-2 text-white font-semibold text-base transition bg-emerald-600 dark:bg-emerald-700"
      style="display: none"
    >
      <span id="outage-banner-text"
        >There are currently 0 outages in the province.</span
      >
    </div> -->

    <!-- Top bar -->
    <div
      class="flex items-center justify-between px-4 py-3 shadow-sm bg-white dark:bg-gray-800"
    >
      <div class="flex items-center gap-3">
        <button
          id="toggle-sidebar"
          aria-label="Toggle sidebar"
          class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        </button>

        <div class="flex items-center gap-3">
          <div
            class="h-8 w-8 rounded-md bg-blue-600 flex items-center justify-center"
          >
            <span class="text-white font-bold">HQ</span>
          </div>
          <h1 class="text-lg font-semibold">Hydro‑Québec | Outage Maps</h1>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2 text-sm">
          <span>Light</span>
          <button
            id="dark-toggle"
            class="relative inline-flex items-center h-6 w-11 rounded-full bg-gray-200 dark:bg-gray-600 focus:outline-none"
          >
            <span
              id="dark-knob"
              class="transform translate-x-0 inline-block h-5 w-5 bg-white rounded-full shadow transition-transform"
            ></span>
          </button>
          <span>Dark</span>
        </div>

        <button
          id="refresh"
          title="Refresh outages"
          class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
      </div>
    </div>

    <div class="flex h-[calc(100vh-56px)]">
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="w-80 bg-white dark:bg-gray-800 p-4 overflow-y-auto z-40"
      >
        <div class="flex items-start justify-between gap-2">
          <div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-50">
              Outage Information
            </h2>
            <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
              These maps show current and planned Hydro‑Québec outages across
              Québec. Click a marker for details.
            </p>
          </div>
          <button
            id="collapse-btn"
            class="text-sm text-gray-500 dark:text-gray-300 hover:text-gray-700"
          >
            Collapse
          </button>
        </div>

        <!-- Map Tabs -->
        <div class="mt-6">
          <div class="map-tabs">
            <div class="map-tab active" data-tab="current">Current Outages</div>
            <div class="map-tab" data-tab="planned">Planned Outages</div>
          </div>

          <!-- Current Outages Stats -->
          <div id="current-stats" class="map-content active">
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">
                    Total Current Outages
                  </p>
                  <p id="total-outages" class="text-2xl font-semibold">—</p>
                </div>
                <div class="flex items-center">
                  <span class="status-indicator status-active"></span>
                  <span class="text-sm text-gray-500">Active</span>
                </div>
              </div>

              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                  Customers Affected
                </p>
                <p id="customers-affected" class="text-sm">—</p>
              </div>

              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                  Last Update
                </p>
                <p id="last-update" class="text-sm">—</p>
              </div>
            </div>
          </div>

          <!-- Planned Outages Stats -->
          <div id="planned-stats" class="map-content">
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">
                    Total Planned Outages
                  </p>
                  <p id="total-planned-outages" class="text-2xl font-semibold">
                    —
                  </p>
                </div>
                <div class="flex items-center">
                  <span class="status-indicator status-planned"></span>
                  <span class="text-sm text-gray-500">Planned</span>
                </div>
              </div>

              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                  Last Update
                </p>
                <p id="planned-last-update" class="text-sm">—</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="text-sm font-medium text-gray-700 dark:text-gray-200">
            Instructions
          </h3>
          <ul
            class="mt-2 list-disc list-inside text-sm text-gray-600 dark:text-gray-300 space-y-1"
          >
            <li>Switch between maps using the tabs above.</li>
            <li>Zoom and pan to explore outages.</li>
            <li>
              Click markers for affected customers & estimated restoration.
            </li>
            <li>Use the dark mode toggle at the top-right.</li>
            <li>
              Search for outages by postal code using the search box on the map.
            </li>
          </ul>
        </div>

        <div class="mt-6">
          <h3 class="text-sm font-medium text-gray-700 dark:text-gray-200">
            Legend
          </h3>
          <div class="mt-2 space-y-2">
            <div class="flex items-center gap-3">
              <span
                class="inline-block h-3 w-3 rounded-full bg-[#ff4500] ring-2 ring-white dark:ring-gray-900"
              ></span>
              <span class="text-sm text-gray-600 dark:text-gray-300"
                >Active outage</span
              >
            </div>
            <div class="flex items-center gap-3">
              <span
                class="inline-block h-3 w-3 rounded-full bg-[#ffa500] ring-2 ring-white dark:ring-gray-900"
              ></span>
              <span class="text-sm text-gray-600 dark:text-gray-300"
                >Planned outage</span
              >
            </div>
          </div>
        </div>
      </aside>

      <!-- Main content with dual maps -->
      <main class="flex-1 relative">
        <!-- Search Box -->
        <div class="search-container">
          <input
            type="text"
            id="postal-code-search"
            class="search-input"
            placeholder="Search by postal code (e.g., H3A, G1V)"
            autocomplete="off"
          />
          <div
            id="search-results"
            class="search-results"
            style="display: none"
          ></div>
        </div>

        <!-- Current Outages Map -->
        <div id="current-map" class="map-container absolute inset-0"></div>

        <!-- Planned Outages Map -->
        <div
          id="planned-map"
          class="map-container absolute inset-0"
          style="display: none"
        ></div>

        <!-- floating status card -->
        <div
          id="status"
          class="absolute top-6 right-6 bg-white dark:bg-gray-800 p-3 rounded-lg shadow-md flex items-center gap-3"
        >
          <div id="spinner" class="spinner"></div>
          <div>
            <div id="status-text" class="text-sm font-medium">
              Loading outages…
            </div>
            <div
              id="status-sub"
              class="text-xs text-gray-500 dark:text-gray-400"
            >
              Fetching data
            </div>
          </div>
        </div>
      </main>
    </div>

    <footer
      class="w-full bg-white dark:bg-gray-800 py-4 text-center border-t border-gray-200 dark:border-gray-700"
    >
      <div
        class="container mx-auto px-4 text-sm text-gray-600 dark:text-gray-300"
      >
        &copy; 2025 Hydro-Québec Outage Maps. Not affiliated with Hydro-Québec.
        Data source: Hydro-Québec public outage feed.
      </div>
    </footer>

    <!-- Leaflet & markercluster JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
      // Elements
      const htmlEl = document.documentElement;
      const darkToggle = document.getElementById("dark-toggle");
      const darkKnob = document.getElementById("dark-knob");
      const toggleSidebarBtn = document.getElementById("toggle-sidebar");
      const sidebar = document.getElementById("sidebar");
      const collapseBtn = document.getElementById("collapse-btn");
      const statusText = document.getElementById("status-text");
      const statusSub = document.getElementById("status-sub");
      const spinner = document.getElementById("spinner");
      const refreshBtn = document.getElementById("refresh");

      // Banner
      const outageBanner = document.getElementById("outage-banner");
      const outageBannerText = document.getElementById("outage-banner-text");

      // Map tabs
      const mapTabs = document.querySelectorAll(".map-tab");
      const mapContents = document.querySelectorAll(".map-content");
      const currentMapContainer = document.getElementById("current-map");
      const plannedMapContainer = document.getElementById("planned-map");

      // Search elements
      const postalCodeSearch = document.getElementById("postal-code-search");
      const searchResults = document.getElementById("search-results");

      // Dark mode state
      const prefersDark =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;
      const saved = localStorage.getItem("hq-dark");
      if (saved === "1" || (saved === null && prefersDark)) {
        htmlEl.classList.add("dark");
        darkKnob.classList.add("translate-x-5");
      }
      darkToggle.addEventListener("click", () => {
        const isDark = htmlEl.classList.toggle("dark");
        localStorage.setItem("hq-dark", isDark ? "1" : "0");
        darkKnob.classList.toggle("translate-x-5");
      });

      // Sidebar toggle
      collapseBtn.addEventListener("click", () => {
        sidebar.style.display = "none";
      });
      toggleSidebarBtn.addEventListener("click", () => {
        sidebar.style.display =
          getComputedStyle(sidebar).display === "none" ? "block" : "none";
      });

      // Maps
      const currentMap = L.map("current-map", { zoomControl: true }).setView(
        [46.8, -71.2],
        7
      );
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          "Developed By Joey Cadieux. Not affiliated with Hydro-Québec",
      }).addTo(currentMap);

      const plannedMap = L.map("planned-map", { zoomControl: true }).setView(
        [46.8, -71.2],
        7
      );
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "© OpenStreetMap contributors",
      }).addTo(plannedMap);

      // Cluster groups
      const outageCluster = L.markerClusterGroup({
        chunkedLoading: true,
        showCoverageOnHover: false,
        maxClusterRadius: 60,
        iconCreateFunction: function (cluster) {
          const count = cluster.getChildCount();
          const html = `<div class="custom-cluster p-2">${count}</div>`;
          return L.divIcon({
            html,
            className: "cluster-wrapper",
            iconSize: L.point(40, 40),
          });
        },
      });
      currentMap.addLayer(outageCluster);

      const plannedCluster = L.markerClusterGroup({
        chunkedLoading: true,
        showCoverageOnHover: false,
        maxClusterRadius: 60,
        iconCreateFunction: function (cluster) {
          const count = cluster.getChildCount();
          const html = `<div class="custom-cluster p-2">${count}</div>`;
          return L.divIcon({
            html,
            className: "cluster-wrapper",
            iconSize: L.point(40, 40),
          });
        },
      });
      plannedMap.addLayer(plannedCluster);

      // API endpoints
      const BIS_URL =
        "http://pannes.hydroquebec.com/pannes/donnees/v3_0/bisversion.json";
      const PROXY = "https://corsproxy.io/?";
      const REFRESH_INTERVAL = 300000; // 5 minutes

      // Store all outages for search functionality
      let allOutages = [];
      let allPlannedOutages = [];
      let allDataFull = []; // Store all raw data for proper categorization

      function createPulseIcon() {
        return L.divIcon({
          className: "pulse-icon",
          html: '<div class="pulse" />',
          iconSize: [18, 18],
          iconAnchor: [9, 9],
        });
      }

      function createPlannedIcon() {
        return L.divIcon({
          className: "planned-icon",
          html: '<div class="planned" />',
          iconSize: [18, 18],
          iconAnchor: [9, 9],
        });
      }

      function showOutageBanner(count) {
        if (count === 0) {
          outageBannerText.textContent =
            "There are currently no outages in the province.";
          outageBanner.classList.remove("bg-red-600", "dark:bg-red-700");
          outageBanner.classList.add("bg-emerald-600", "dark:bg-emerald-700");
        } else {
          outageBannerText.textContent = `There are currently ${count} outage${
            count > 1 ? "s" : ""
          } in the province.`;
          outageBanner.classList.remove(
            "bg-emerald-600",
            "dark:bg-emerald-700"
          );
          outageBanner.classList.add("bg-red-600", "dark:bg-red-700");
        }
        outageBanner.style.display = "block";
      }

      // Postal code to coordinates mapping (expanded list of Quebec postal codes)
      const postalCodeCoordinates = {
        H3A: [45.5048, -73.5772], // Montreal
        H2X: [45.5107, -73.565], // Montreal
        H1A: [45.6367, -73.5],   // Montreal
        H2L: [45.5239, -73.5789], // Montreal
        H2Z: [45.5173, -73.5613], // Montreal
        H3C: [45.4973, -73.5674], // Montreal
        H3E: [45.4845, -73.5889], // Montreal
        H3H: [45.5016, -73.5921], // Montreal
        H3J: [45.5056, -73.6051], // Montreal
        H4C: [45.4739, -73.7213], // Montreal
        H4P: [45.5383, -73.8159], // Montreal
        H8X: [45.3924, -73.6996], // Brossard/Montreal
        G1V: [46.7913, -71.2879], // Quebec City
        G1A: [46.8139, -71.2080], // Quebec City
        G1B: [46.8156, -71.2047], // Quebec City
        G1C: [46.8169, -71.2089], // Quebec City
        G1R: [46.8125, -71.2154], // Quebec City
        G1S: [46.8163, -71.2200], // Quebec City
        G2A: [46.6528, -71.2119], // Beauport
        G3A: [46.6222, -71.8308], // Montmorency
        J7V: [45.5333, -73.8667], // Laval
        J7N: [45.6, -73.85],       // Laval
        J7T: [45.65, -74.3333],    // Saint-Jérôme
        J1H: [45.4, -71.9],        // Sherbrooke
        J1J: [45.4056, -71.8933], // Sherbrooke
        J1M: [45.4167, -71.9], // Sherbrooke
        J1N: [45.43, -71.89],  // Sherbrooke
        J1X: [45.46, -71.82],  // Sherbrooke
        G7H: [48.4333, -71.0667], // Saguenay
        G7X: [48.3917, -70.9333], // Saguenay
        G6V: [46.3667, -72.55],   // Trois-Rivières
        G8T: [46.3667, -72.5667], // Trois-Rivières
        G8V: [46.3833, -72.6],    // Trois-Rivières
        G8Z: [46.4, -72.6333],    // Trois-Rivières
        G9A: [46.35, -72.5667],   // Shawinigan
        G9N: [46.3667, -72.6667], // Shawinigan
        G9P: [46.35, -72.55],     // Shawinigan
        J6A: [45.65, -73.6333],   // Repentigny
        J6E: [45.3, -73.25],      // Saint-Jean-sur-Richelieu
        J6H: [45.3256, -73.2567], // Saint-Jean-sur-Richelieu
        J2S: [45.4167, -72.0167], // Drummondville
        J2T: [45.4333, -72.0333], // Drummondville
        J2V: [45.4, -72.0667],    // Drummondville
        J6J: [46.0333, -73.1167], // Joliette
        J6E: [45.3, -73.25],      // Saint-Jean-sur-Richelieu
        G5L: [48.45, -68.5333],   // Rimouski
        G5H: [48.4667, -68.5667], // Rimouski
        G5A: [48.3, -68.5333],    // Rimouski
        G5M: [48.4833, -68.5],    // Rimouski
        G6W: [46.75, -71.3667],   // Lévis
        G6X: [46.7833, -71.3667], // Lévis
        G6Z: [46.8, -71.35],      // Lévis
        J7W: [45.4833, -73.7667], // Brossard
        J7Y: [45.46, -73.7667],   // Brossard
        J4Z: [45.5333, -73.5167], // Longueuil
        J4H: [45.5333, -73.5333], // Longueuil
        J4K: [45.55, -73.5667],   // Longueuil
        J5R: [45.65, -73.45],     // Terrebonne
        J5H: [45.6833, -73.5],    // Terrebonne
        J3V: [45.5333, -73.2833], // Saint-Hyacinthe
        J3Z: [45.6333, -73.3333], // Saint-Hyacinthe
        J3X: [45.5667, -73.3],    // Saint-Hyacinthe
        J8Y: [45.4667, -75.7],    // Gatineau
        J9H: [45.25, -75.75],     // Gatineau
        J9J: [45.3, -75.5],       // Gatineau
        H1A: [45.6333, -73.5],    // Montreal East
        H1B: [45.6333, -73.5167], // Montreal East
        H1C: [45.6333, -73.5333], // Montreal East
        H1G: [45.6333, -73.5667], // Montreal East
        H1H: [45.6333, -73.5833], // Montreal East
        H1K: [45.6333, -73.6],    // Montreal East
        H1L: [45.6333, -73.6167], // Montreal East
        H1M: [45.6333, -73.6333], // Montreal East
        H1N: [45.6333, -73.65],   // Montreal East
        H2E: [45.545, -73.5833],  // Montreal
        H2G: [45.5367, -73.5945], // Montreal
        H2H: [45.5317, -73.6067], // Montreal
        H2J: [45.527, -73.6189],  // Montreal
        H2K: [45.5222, -73.6311], // Montreal
        H2M: [45.5178, -73.6367], // Montreal
        H2N: [45.5144, -73.6422], // Montreal
        H2P: [45.5122, -73.6556], // Montreal
        H2R: [45.5111, -73.6733], // Montreal
        H2S: [45.5156, -73.6839], // Montreal
        H2T: [45.5239, -73.6889], // Montreal
        H2V: [45.5367, -73.6733], // Montreal
        H2W: [45.5478, -73.6556], // Montreal
        H2X: [45.5107, -73.565],  // Montreal
        H2Y: [45.5073, -73.5589], // Montreal
        H3B: [45.4973, -73.5674], // Montreal
        H3G: [45.4939, -73.5811], // Montreal
        H3K: [45.4895, -73.5978], // Montreal
        H3L: [45.4878, -73.6122], // Montreal
        H3M: [45.485, -73.6289],  // Montreal
        H3N: [45.4839, -73.6422], // Montreal
        H3P: [45.481, -73.6556],  // Montreal
        H3R: [45.4717, -73.6767], // Montreal
        H3S: [45.4661, -73.6889], // Montreal
        H3T: [45.4595, -73.6939], // Montreal
        H3V: [45.4556, -73.6889], // Montreal
        H3W: [45.455, -73.6733],  // Montreal
        H3X: [45.4561, -73.6556], // Montreal
        H3Y: [45.4628, -73.6389], // Montreal
        H3Z: [45.4656, -73.6222], // Montreal
        H4A: [45.4733, -73.6056], // Montreal
        H4B: [45.4806, -73.5889], // Montreal
        H4E: [45.4867, -73.5722], // Montreal
        H4G: [45.4939, -73.5556], // Montreal
        H4H: [45.5022, -73.5389], // Montreal
        H4J: [45.5122, -73.5222], // Montreal
        H4K: [45.5222, -73.5056], // Montreal
        H4L: [45.5328, -73.4889], // Montreal
        H4M: [45.5439, -73.4722], // Montreal
        H4N: [45.5556, -73.4556], // Montreal
        H4R: [45.5333, -73.4222], // Montreal
        H4S: [45.5117, -73.4583], // Montreal
        H4T: [45.495, -73.4944],  // Montreal
        H4V: [45.4783, -73.5306], // Montreal
        H4W: [45.4616, -73.5667], // Montreal
        H4X: [45.4533, -73.5833], // Montreal
        H4Y: [45.445, -73.6],     // Montreal
        H4Z: [45.4372, -73.6167], // Montreal
        H5A: [45.4289, -73.6333], // Montreal
        H5B: [45.4211, -73.6489], // Montreal
        H5C: [45.4128, -73.6656], // Montreal
        H5E: [45.4056, -73.6822], // Montreal
        H5G: [45.3972, -73.6989], // Montreal
        H5H: [45.3889, -73.7156], // Montreal
        H5J: [45.3806, -73.7322], // Montreal
        H5K: [45.3722, -73.7489], // Montreal
        H5L: [45.3639, -73.7656], // Montreal
        H5M: [45.3561, -73.7822], // Montreal
        H5N: [45.3483, -73.7989], // Montreal
        H5P: [45.3406, -73.8156], // Montreal
        H5R: [45.3328, -73.8322], // Montreal
        H5S: [45.3256, -73.8489], // Montreal
        H5T: [45.3178, -73.8656], // Montreal
        H5V: [45.3106, -73.8822], // Montreal
        H5W: [45.3028, -73.8989], // Montreal
        H5X: [45.2956, -73.9156], // Montreal
        H5Y: [45.2878, -73.9322], // Montreal
        H5Z: [45.2806, -73.9489], // Montreal
        H6A: [45.2728, -73.9656], // Montreal
        H6B: [45.2656, -73.9822], // Montreal
        H6C: [45.2578, -73.9989], // Montreal
        H6E: [45.2506, -74.0156], // Montreal
        H6G: [45.2428, -74.0322], // Montreal
        H6H: [45.2356, -74.0489], // Montreal
        H6J: [45.2278, -74.0656], // Montreal
        H6K: [45.2206, -74.0822], // Montreal
        H6L: [45.2128, -74.0989], // Montreal
        H6M: [45.205, -74.1156],  // Montreal
        H6N: [45.1972, -74.1322], // Montreal
        H6P: [45.1894, -74.1489], // Montreal
        H6R: [45.1822, -74.1656], // Montreal
        H6S: [45.1744, -74.1822], // Montreal
        H6T: [45.1672, -74.1989], // Montreal
        H6V: [45.1594, -74.2156], // Montreal
        H6W: [45.1516, -74.2322], // Montreal
        H6X: [45.1444, -74.2489], // Montreal
        H6Y: [45.1366, -74.2656], // Montreal
        H6Z: [45.1294, -74.2822], // Montreal
        H7A: [45.1216, -74.2989], // Montreal
        H7B: [45.1144, -74.3156], // Laval/Montreal
        H7C: [45.1066, -74.3322], // Laval/Montreal
        H7E: [45.0988, -74.3489], // Laval/Montreal
        H7G: [45.0916, -74.3656], // Laval/Montreal
        H7H: [45.0838, -74.3822], // Laval/Montreal
        H7J: [45.0766, -74.3989], // Laval/Montreal
        H7K: [45.0688, -74.4156], // Laval/Montreal
        H7L: [45.0616, -74.4322], // Laval/Montreal
        H7M: [45.0538, -74.4489], // Laval/Montreal
        H7N: [45.0466, -74.4656], // Laval/Montreal
        H7P: [45.0388, -74.4822], // Laval/Montreal
        H7R: [45.0316, -74.4989], // Laval/Montreal
        H7S: [45.0238, -74.5156], // Laval/Montreal
        H7T: [45.0166, -74.5322], // Laval/Montreal
        H7V: [44.9888, -74.5489], // Laval/Montreal
        H7W: [44.9816, -74.5656], // Laval/Montreal
        H7X: [44.9738, -74.5822], // Laval/Montreal
        H7Y: [44.9666, -74.5989], // Laval/Montreal
        H7Z: [44.9588, -74.6156], // Laval/Montreal
        H8A: [44.9516, -74.6322], // Laval/Montreal
        H8B: [44.9438, -74.6489], // Laval/Montreal
        H8C: [44.9366, -74.6656], // Laval/Montreal
        H8E: [44.9288, -74.6822], // Laval/Montreal
        H8G: [44.9216, -74.6989], // Laval/Montreal
        H8H: [44.9138, -74.7156], // Laval/Montreal
        H8J: [44.9066, -74.7322], // Laval/Montreal
        H8K: [44.8988, -74.7489], // Laval/Montreal
        H8L: [44.8916, -74.7656], // Laval/Montreal
        H8M: [44.8838, -74.7822], // Laval/Montreal
        H8N: [44.8766, -74.7989], // Laval/Montreal
        H8P: [44.8688, -74.8156], // Laval/Montreal
        H8R: [44.8616, -74.8322], // Laval/Montreal
        H8S: [44.8538, -74.8489], // Laval/Montreal
        H8T: [44.8466, -74.8656], // Laval/Montreal
        H8V: [44.8388, -74.8822], // Laval/Montreal
        H8W: [44.8316, -74.8989], // Laval/Montreal
        H8X: [45.3924, -73.6996], // Brossard
        H8Y: [44.8238, -74.9156], // Laval/Montreal
        H8Z: [44.8166, -74.9322], // Laval/Montreal
        H9A: [44.8088, -74.9489], // Laval/Montreal
        H9B: [44.8016, -74.9656], // Laval/Montreal
        H9C: [44.7938, -74.9822], // Laval/Montreal
        H9E: [44.7866, -74.9989], // Laval/Montreal
        H9G: [44.7788, -75.0156], // Laval/Montreal
        H9H: [44.7716, -75.0322], // Laval/Montreal
        H9J: [44.7638, -75.0489], // Laval/Montreal
        H9K: [44.7566, -75.0656], // Laval/Montreal
        H9L: [44.7488, -75.0822], // Laval/Montreal
        H9M: [44.7416, -75.0989], // Laval/Montreal
        H9N: [44.7338, -75.1156], // Laval/Montreal
        H9P: [44.7266, -75.1322], // Laval/Montreal
        H9R: [44.7188, -75.1489], // Laval/Montreal
        H9S: [44.7116, -75.1656], // Laval/Montreal
        H9T: [44.7038, -75.1822], // Laval/Montreal
        H9V: [44.6966, -75.1989], // Laval/Montreal
        H9W: [44.6888, -75.2156], // Laval/Montreal
        H9X: [44.6816, -75.2322], // Laval/Montreal
        H9Y: [44.6738, -75.2489], // Laval/Montreal
        H9Z: [44.6666, -75.2656], // Laval/Montreal
      };

      // Search functionality
      function performSearch(query) {
        if (!query || query.length < 1) {
          searchResults.style.display = "none";
          return;
        }

        const normalizedQuery = query.toUpperCase().trim();
        const matches = Object.keys(postalCodeCoordinates).filter((code) =>
          code.startsWith(normalizedQuery) // Changed from includes to startsWith for better matching
        );

        if (matches.length > 0) {
          searchResults.innerHTML = "";
          matches.forEach((code) => {
            const item = document.createElement("div");
            item.className = "search-result-item";
            item.textContent = code;
            item.addEventListener("click", () => {
              postalCodeSearch.value = code;
              searchResults.style.display = "none";
              zoomToPostalCode(code);
            });
            searchResults.appendChild(item);
          });
          searchResults.style.display = "block";
        } else {
          searchResults.innerHTML =
            '<div class="search-no-results">No matching postal codes found</div>';
          searchResults.style.display = "block";
        }
      }

      function zoomToPostalCode(postalCode) {
        const coords = postalCodeCoordinates[postalCode];
        if (coords) {
          // Determine which map is currently active
          const activeTab = document
            .querySelector(".map-tab.active")
            .getAttribute("data-tab");
          const map = activeTab === "current" ? currentMap : plannedMap;

          // Zoom to the postal code area
          map.setView(coords, 12);

          // Highlight outages in this area
          highlightOutagesInArea(coords, activeTab);
        }
      }

      function highlightOutagesInArea(centerCoords, type) {
        // Clear any existing highlights
        clearHighlights();

        // Add a circle to show the search area
        const circle = L.circle(centerCoords, {
          color: "#3b82f6",
          fillColor: "#3b82f6",
          fillOpacity: 0.1,
          radius: 5000, // 5km radius
        });

        if (type === "current") {
          circle.addTo(currentMap);
          window.currentHighlight = circle;
        } else {
          circle.addTo(plannedMap);
          window.plannedHighlight = circle;
        }
      }

      function clearHighlights() {
        if (window.currentHighlight) {
          currentMap.removeLayer(window.currentHighlight);
        }
        if (window.plannedHighlight) {
          plannedMap.removeLayer(window.plannedHighlight);
        }
      }

      // Event listeners for search
      postalCodeSearch.addEventListener("input", (e) => {
        performSearch(e.target.value);
      });

      postalCodeSearch.addEventListener("focus", () => {
        if (postalCodeSearch.value.length >= 2) {
          performSearch(postalCodeSearch.value);
        }
      });

      document.addEventListener("click", (e) => {
        if (
          !postalCodeSearch.contains(e.target) &&
          !searchResults.contains(e.target)
        ) {
          searchResults.style.display = "none";
        }
      });

      // Map tab switching
      mapTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          // Update active tab
          mapTabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");

          // Update active content
          const tabName = tab.getAttribute("data-tab");
          mapContents.forEach((content) => {
            content.classList.remove("active");
            if (content.id === `${tabName}-stats`) {
              content.classList.add("active");
            }
          });

          // Show/hide maps
          if (tabName === "current") {
            currentMapContainer.style.display = "block";
            plannedMapContainer.style.display = "none";
            // Invalidate size to ensure map renders correctly
            setTimeout(() => {
              currentMap.invalidateSize();
            }, 100);
          } else {
            currentMapContainer.style.display = "none";
            plannedMapContainer.style.display = "block";
            // Invalidate size to ensure map renders correctly
            setTimeout(() => {
              plannedMap.invalidateSize();
            }, 100);
          }
        });
      });

      // Main data fetching function
      function fetchOutages() {
        statusText.textContent = "Fetching outage data…";
        statusSub.textContent = "";
        spinner.style.display = "block";

        // Fetch current outages
        fetchCurrentOutages()
          .then(() => {
            // Fetch planned outages
            return fetchPlannedOutages();
          })
          .then(() => {
            spinner.style.display = "none";
            statusText.textContent = "Data loaded successfully";
            statusSub.textContent = `Last updated: ${new Date().toLocaleString()}`;
          })
          .catch((err) => {
            console.error(err);
            spinner.style.display = "none";
            statusText.textContent = "Error loading outages";
            statusSub.textContent = err.message || "Please try again later";

            // On error, hide the banner
            outageBannerText.textContent =
              "Unable to load outage info at this time.";
            outageBanner.classList.remove(
              "bg-emerald-600",
              "dark:bg-emerald-700",
              "bg-red-600",
              "dark:bg-red-700"
            );
            outageBanner.classList.add("bg-gray-700", "dark:bg-gray-900");
            outageBanner.style.display = "block";
          });
      }

      // Fetch current outages
      function fetchCurrentOutages() {
        return fetch(PROXY + BIS_URL)
          .then((r) => {
            if (!r.ok) throw new Error(r.status);
            return r.json();
          })
          .then((bis) =>
            fetch(
              PROXY +
                `http://pannes.hydroquebec.com/pannes/donnees/v3_0/bismarkers${bis}.json`
            )
          )
          .then((r) => {
            if (!r.ok) throw new Error(r.status);
            return r.json();
          })
          .then((data) => {
            processCurrentOutages(data);
          });
      }

      // Process current outages data
      function processCurrentOutages(data) {
        outageCluster.clearLayers();
        allOutages = [];
        allDataFull = data.pannes || []; // Store full data
        let outageCount = 0;
        let totalCustomers = 0;

        if (!data || !data.pannes || data.pannes.length === 0) {
          document.getElementById("total-outages").textContent = "0";
          document.getElementById("customers-affected").textContent = "0";
          document.getElementById("last-update").textContent =
            new Date().toLocaleString();
          showOutageBanner(0);
          return;
        }

        data.pannes.forEach((p) => {
          try {
            const coords = JSON.parse(p[4]);
            const lon = coords[0],
              lat = coords[1];
            const nbClients = parseInt(p[7]) || 0;

            // Check if this is a CURRENT outage (not planned)
            const isCurrentOutage = !checkIfPlannedOutage(p);

            if (isCurrentOutage) {
              outageCount++;
              totalCustomers += nbClients;

              const marker = L.marker([lat, lon], {
                icon: createPulseIcon(),
              });

              const startTime = p[1]
                ? new Date(p[1]).toLocaleString()
                : "Unknown";
              const estRestoration =
                p[2] && p[2] !== "null"
                  ? new Date(p[2]).toLocaleString()
                  : "Unknown";

              const popupHtml = `
                            <div class="text-sm max-w-xs">
                                <strong class="text-red-600">Current Outage</strong><br/>
                                <strong>Customers affected:</strong> ${nbClients.toLocaleString()}<br/>
                                <strong>Start:</strong> ${startTime}<br/>
                                <strong>Estimated restoration:</strong> ${estRestoration}<br/>
                                <strong>Status code:</strong> ${p[5] || "N/A"}
                            </div>
                        `;
              marker.bindPopup(popupHtml, { maxWidth: 300 });
              outageCluster.addLayer(marker);

              // Store for search
              allOutages.push({
                coords: [lat, lon],
                marker: marker,
                data: p,
              });
            }
          } catch (e) {
            console.warn("bad panne entry", e, p);
          }
        });

        document.getElementById("total-outages").textContent =
          outageCount.toLocaleString();
        document.getElementById("customers-affected").textContent =
          totalCustomers.toLocaleString();
        document.getElementById("last-update").textContent =
          new Date().toLocaleString();
        showOutageBanner(outageCount);

        // Fit bounds for current outages
        if (outageCount > 0) {
          const currentBounds = outageCluster.getBounds();
          if (currentBounds.isValid()) {
            currentMap.fitBounds(currentBounds, {
              padding: [60, 60],
              maxZoom: 10,
            });
          }
        }
      }

      // Fetch planned outages
      function fetchPlannedOutages() {
        // Use the same API endpoint but filter for planned outages
        return fetch(PROXY + BIS_URL)
          .then((r) => {
            if (!r.ok) throw new Error(r.status);
            return r.json();
          })
          .then((bis) =>
            fetch(
              PROXY +
                `http://pannes.hydroquebec.com/pannes/donnees/v3_0/bismarkers${bis}.json`
            )
          )
          .then((r) => {
            if (!r.ok) throw new Error(r.status);
            return r.json();
          })
          .then((data) => {
            processPlannedOutages(data);
          });
      }

      // Process planned outages data
      function processPlannedOutages(data) {
        plannedCluster.clearLayers();
        allPlannedOutages = [];
        let plannedCount = 0;

        if (!data || !data.pannes || data.pannes.length === 0) {
          document.getElementById("total-planned-outages").textContent = "0";
          document.getElementById("planned-last-update").textContent =
            new Date().toLocaleString();
          return;
        }

        // Process ALL entries, showing planned ones on this map
        data.pannes.forEach((p) => {
          try {
            const coords = JSON.parse(p[4]);
            const lon = coords[0],
              lat = coords[1];
            const nbClients = parseInt(p[7]) || 0;

            // Check if this is a PLANNED outage
            const isPlannedOutage = checkIfPlannedOutage(p);

            if (isPlannedOutage) {
              plannedCount++;

              const marker = L.marker([lat, lon], {
                icon: createPlannedIcon(),
              });

              const startTime = p[1]
                ? new Date(p[1]).toLocaleString()
                : "Unknown";
              const estRestoration =
                p[2] && p[2] !== "null"
                  ? new Date(p[2]).toLocaleString()
                  : "Unknown";

              const popupHtml = `
                            <div class="text-sm max-w-xs">
                                <strong class="text-orange-600">Planned Outage</strong><br/>
                                <strong>Customers affected:</strong> ${nbClients.toLocaleString()}<br/>
                                <strong>Start:</strong> ${startTime}<br/>
                                <strong>Estimated restoration:</strong> ${estRestoration}<br/>
                                <strong>Status code:</strong> ${
                                  p[5] || "N/A"
                                }<br/>
                                <em>This is a planned maintenance outage</em>
                            </div>
                        `;
              marker.bindPopup(popupHtml, { maxWidth: 300 });
              plannedCluster.addLayer(marker);

              // Store for search
              allPlannedOutages.push({
                coords: [lat, lon],
                marker: marker,
                data: p,
              });
            }
          } catch (e) {
            console.warn("bad planned outage entry", e, p);
          }
        });

        document.getElementById("total-planned-outages").textContent =
          plannedCount.toLocaleString();
        document.getElementById("planned-last-update").textContent =
          new Date().toLocaleString();

        // Fit bounds for planned outages
        if (plannedCount > 0) {
          const plannedBounds = plannedCluster.getBounds();
          if (plannedBounds.isValid()) {
            plannedMap.fitBounds(plannedBounds, {
              padding: [60, 60],
              maxZoom: 10,
            });
          }
        }
      }

      // Helper function to identify planned outages
      function checkIfPlannedOutage(outageData) {
        // outageData structure:
        // [0] = id
        // [1] = start time
        // [2] = estimated restoration
        // [3] = status/type code
        // [4] = coordinates
        // [5] = status code (may contain PLAN indicator)
        // [6] = ?
        // [7] = number of customers affected
        // [8] = ?
        // [9] = description/reason

        // Check 1: Look for "PLAN" in the status code (field [5])
        if (outageData[5]) {
          const statusCode = outageData[5].toString().toUpperCase();
          if (statusCode.includes("PLAN") || statusCode.includes("MAINTENANCE") || statusCode.includes("SCHEDULED")) {
            return true;
          }
        }

        // Check 2: Look for planned indicators in the reason/description (field [9])
        if (outageData[9]) {
          const description = outageData[9].toString().toUpperCase();
          if (
            description.includes("PLAN") ||
            description.includes("MAINTENANCE") ||
            description.includes("SCHEDULED") ||
            description.includes("ENTRETIEN") ||
            description.includes("PROGRAMMÉ")
          ) {
            return true;
          }
        }

        // Check 3: Check if it has specific field patterns for planned outages
        // Planned outages often have different status fields
        if (outageData[3]) {
          const typeCode = outageData[3].toString().toUpperCase();
          if (typeCode.includes("P") || typeCode === "1" || typeCode.includes("PLANNED")) {
            return true;
          }
        }

        // Check 4: Start time in the future = likely planned
        if (outageData[1]) {
          const startTime = new Date(outageData[1]);
          const now = new Date();
          // If starts more than 30 minutes in the future, it's likely planned
          if (startTime - now > 30 * 60 * 1000) {
            return true;
          }
        }

        // Default: treat as current outage
        return false;
      }

      // Initialize the application
      fetchOutages();
      setInterval(fetchOutages, REFRESH_INTERVAL);
      refreshBtn && refreshBtn.addEventListener("click", fetchOutages);

      // Close sidebar when clicking outside on mobile
      document.addEventListener("click", (ev) => {
        if (
          window.innerWidth <= 768 &&
          !sidebar.contains(ev.target) &&
          !toggleSidebarBtn.contains(ev.target)
        ) {
          sidebar.style.display = "none";
        }
      });

      // Invalidate map size when sidebar toggles
      const obs = new MutationObserver(() => {
        setTimeout(() => {
          currentMap.invalidateSize();
          plannedMap.invalidateSize();
        }, 300);
      });
      obs.observe(sidebar, { attributes: true, attributeFilter: ["style"] });
    </script>
  </body>
</html>
